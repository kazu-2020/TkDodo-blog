version: 0.1
frontend:
  phases:
    preBuild:
      commands:
        - yarn install
    build:
      commands:
        - SENTRY_PROJECT_NAME="editorialhands"
        - GIT_REF=$(git describe --always)
        - SENTRY_RELEASE_VERSION="${SENTRY_PROJECT_NAME}@${GIT_REF}"
        - VERSION=$SENTRY_RELEASE_VERSION yarn build:amplify
        - curl -sL https://sentry.io/get-cli/ | bash
        - sentry-cli releases new -p $SENTRY_PROJECT_NAME $SENTRY_RELEASE_VERSION
        - sentry-cli releases -p $SENTRY_PROJECT_NAME files $SENTRY_RELEASE_VERSION upload-sourcemaps .nuxt/dist/client --rewrite --url-prefix '~/_nuxt/'
        # TODO: Sentry の Repository integration を ON にすること
        # - sentry-cli releases set-commits --auto $SENTRY_RELEASE_VERSION
        - sentry-cli releases finalize $SENTRY_RELEASE_VERSION
        - sentry-cli releases deploys $SENTRY_RELEASE_VERSION new -e production
  artifacts:
    # IMPORTANT - Please verify your build output directory
    baseDirectory: dist/
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
