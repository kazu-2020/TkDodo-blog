# Build Specification Reference for CodeBuild: https://docs.aws.amazon.com/codebuild/latest/userguide/build-spec-ref.html

version: 0.2

phases:
  install:
    commands:
      - yum -y install python-pip
      - pip install awscli

  pre_build:
    commands:
      - curl -qL -o aws_credentials.json 169.254.170.2$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI > aws_credentials.json
      - export AWS_ACCESS_KEY_ID=`jq -r '.AccessKeyId' aws_credentials.json`
      - export AWS_SECRET_ACCESS_KEY=`jq -r '.SecretAccessKey' aws_credentials.json`
      - export AWS_SESSION_TOKEN=`jq -r '.Token' aws_credentials.json`

      - echo Logging in to Amazon ECR...
      - $(aws ecr get-login --no-include-email --region $AWS_DEFAULT_REGION)

  build:
    commands:
      - docker-compose -f docker-compose.cody-deploy.yml build
      - docker-compose -f docker-compose.cody-deploy.yml run web bin/setup
      - docker-compose -f docker-compose.cody-deploy.yml run web bundle exec jets deploy
